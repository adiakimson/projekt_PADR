---
title: "Dokumentacja projekt PADR"
author: "Karolina Joachimczyk"
date: "`r Sys.Date()`"
output: html_document
---

Projekt z Podstaw Analizy Danych w R autorstwa Karoliny Joachimczyk i Katarzyny Latos.

Projekt zakłada obróbkę oraz analizę danych GUS w celu przewidywania liczby zgonów pacjentów trafiających do Szpitalnych Oddziałów Ratunkowych w poszczególnych województwach na podstawie wybranych cech o największym wpływie.

```{r, include=FALSE}
library(readxl)
path <- "C:/dane_gus_uzupelnione.xlsx"
my_data <- read_excel(path, 2)
path1 <- "C:/dane_guss.xlsx"
my_data_s<-read_excel(path1, 1)
mydata_siec<-subset(my_data_s,select=-c(7:98))
```

Najpierw dokonano oceny i wstępnej obróbki danych. Następnie dokonano wykreślenia
pojedynczych zależności i zbadania ich wpływu na śmiertelność.

```{r, include=FALSE}
#usuwamy kolumne lozek 18 i kolumne kod
bez_kolumny_1<-subset(my_data, select=-c(Kod))
bez_kolumny_lozek_18<-subset(bez_kolumny_1,select=-c(50))

#usunięcie MIEJSCA DZIENNE
bez_nazwy<-subset(bez_kolumny_lozek_18,select=-c(2))
bezreszty1<-subset(bez_nazwy,select=-c(3:15))
bezcalego1<-subset(bezreszty1,select=-c(2:3))

#usunięcie ŁÓŻKA OGÓŁEM + ŁÓŻKA DLA MŁODZIEŻY + ŁÓŻKA DLA KLINIK
bez3calych<-subset(bezcalego1,select=-c(19:63))
bez3calych1<-subset(bez3calych,select=-c(18:19))

#USUWAMY PACJENCI DO 18 + PACJENCI POWYŻEJ 65
bezpacjentow<-subset(bez3calych1,select=-c(51:80))
bezpacjentow1<-subset(bezpacjentow,select=-c(50:51))

#usuwamy wiersz drugi - [osoba]
library(dplyr)
bezpacjentow1wiersza<-bezpacjentow1%>%slice(-c(2))

smierccc<-subset(bezpacjentow1wiersza, select=-c(1:81))
smierc3<-smierccc%>%slice(-c(3:18))
danesmierc<-smierc3%>%slice(c(2))

#leczeni 1 dnia
dzien1<-subset(bezpacjentow1wiersza, select=-c(1,18:97))
dzien1wiersz<-dzien1%>%slice(c(2))

#leczeni klinicznie
klinicznie<-subset(bezpacjentow1wiersza, select=-c(1:49,66:97))
kliniczniewiersz<-klinicznie%>%slice(c(2))

```

```{r, echo=FALSE}
library(ggplot2)
plot(2006:2021,danesmierc,col="red",xlab = "Lata", ylab = "Liczba zgonów",pch=20,cex=2, main="Osoby ze stwierdzonym zgonem przed podjęciem leczenia \n lub w trakcie na przestrzeni lat")

```

```{r, echo=FALSE}
plot(2006:2021,danesmierc,col="red",xlab = "Lata", ylab = "Liczba zgonów",pch=20,cex=2, main="Liczba osób zmarłych przed podjęciem leczenia \n a liczba pacjentów wyleczonych 1-go dnia")
par(new=TRUE)
plot(2006:2021,dzien1wiersz,col="green",pch=20,cex=2,axes=FALSE,ann=FALSE)
axis(4)
mtext("Liczba wyleczonych 1-go dnia", side=4)
```

```{r, echo=FALSE}
plot(2006:2021,danesmierc,col="red",xlab = "Lata", ylab = "Liczba zgonów",pch=20,cex=2, main="Liczba osób zmarłych przed podjęciem leczenia \n a liczba pacjentów leczonych klinicznie")
par(new=TRUE)
plot(2006:2021,kliniczniewiersz,col="green",pch=20,cex=2,axes=FALSE,ann=FALSE)
axis(4)
mtext("Liczba przyjętych klinicznie", side=4)

```

```{r, echo=FALSE}
plot(2006:2021,danesmierc,col="red",xlab = "Lata", ylab = "Liczba zgonów",pch=20,cex=2, main="Liczba pacjentów leczonych klinicznie \n oraz liczba osób wyleczonych 1-go dnia \n a liczba zmarłych przed podjęciem leczenia")
par(new=TRUE)
plot(2006:2021,kliniczniewiersz,col="green",pch=20,cex=2,axes=FALSE,ann=FALSE)
axis(4)
par(new=TRUE)
plot(2006:2021,dzien1wiersz,col="blue",pch=20,cex=2,axes=FALSE,ann=FALSE)
mtext("Liczba pacjentów", side=4)
```

Podgląd danych z najważniejszymi cechami.

```{r}
summary(mydata_siec)
```

Wykonanie predykcji modelem regresyjnym.

```{r, include=FALSE}
library("readxl")
r2006<-read_excel(path1,1)
r2006<-subset(r2006,select=c(1:6))
r2007<-read_excel(path1,2)

library(forecast)
library(caret)
library(e1071)
library(randomForest)
#przewidywanie na podst sredniej
test_data<-r2006
train_data<-r2007
#tworzenie i testowanie modelu
set.seed(1234)
trControl <- trainControl(method = "cv",
                          number = 10,
                          search = "grid")
rf_default <- train(Smierc~.,train_data,"rf",
                    metric = "RMSE",
                    trControl = trControl)
print(rf_default)
rf_default$results
#best mtry
set.seed(1234)
tuneGrid <- expand.grid(.mtry = c(1: 10))
rf_mtry <- train(Smierc~.,
                 data = train_data,
                 method = "rf",
                 metric = "RMSE",
                 tuneGrid = tuneGrid,
                 trControl = trControl,
                 importance = TRUE,
                 nodesize = 14,
                 ntree = 300)
print(rf_mtry)
best_mtry<-rf_mtry$bestTune$mtry
max_mtry<-max(rf_mtry$results$RMSE)
#best maxnodes
store_maxnode <- list()
tuneGrid <- expand.grid(.mtry = best_mtry)
for (maxnodes in c(5: 15)) {
  set.seed(1234)
  rf_maxnode <- train(Smierc~.,
                      data = train_data,
                      method = "rf",
                      metric = "RMSE",
                      tuneGrid = tuneGrid,
                      trControl = trControl,
                      importance = TRUE,
                      nodesize = 14,
                      maxnodes = maxnodes,
                      ntree = 300)
  current_iteration <- toString(maxnodes)
  store_maxnode[[current_iteration]] <- rf_maxnode
}
results_mtry <- resamples(store_maxnode)
summary(results_mtry)
#best ntrees
store_maxtrees <- list()
for (ntree in c(250, 300, 350, 400, 450, 500, 550, 600, 800, 1000, 2000)) {
  set.seed(5678)
  rf_maxtrees <- train(Smierc~.,
                       data = train_data,
                       method = "rf",
                       metric = "RMSE",
                       tuneGrid = tuneGrid,
                       trControl = trControl,
                       importance = TRUE,
                       nodesize = 14,
                       maxnodes = 24,
                       ntree = ntree)
  key <- toString(ntree)
  store_maxtrees[[key]] <- rf_maxtrees
}
results_tree <- resamples(store_maxtrees)
summary(results_tree)
#best parameters
fit_rf <- train(Smierc~.,
                train_data,
                method = "rf",
                metric = "RMSE",
                tuneGrid = tuneGrid,
                trControl = trControl,
                importance = TRUE,
                nodesize = 14,
                ntree = 2000,
                maxnodes = 15)
#prediction
prediction <-predict(fit_rf, test_data)
#confusion matrix
smierc_vec<-as.numeric(unlist(test_data$Smierc))
confusionMatrix(
  factor(prediction, levels = 1:16),
  factor(smierc_vec, levels=1:16)
)
```

```{r, echo=FALSE}
print(rf_mtry)
best_mtry<-rf_mtry$bestTune$mtry
max_mtry<-max(rf_mtry$results$RMSE)
results_mtry <- resamples(store_maxnode)
summary(results_mtry)
results_tree <- resamples(store_maxtrees)
summary(results_tree)
```

```{r, echo=FALSE}
#prediction
prediction <-predict(fit_rf, test_data)
#confusion matrix
smierc_vec<-as.numeric(unlist(test_data$Smierc))
confusionMatrix(
  factor(prediction, levels = 1:16),
  factor(smierc_vec, levels=1:16)
)
#wyswietlenie
set.seed(120)  # Setting seed
Wagi_cech = randomForest(x = train_data,
                             y = train_data$Smierc,
                             ntree = 2000)
randomForest::varImpPlot(Wagi_cech)
```

Rezultaty osiągnięte przy pomocy sieci neuronowej.

```{r, include=FALSE}
library(neuralnet)

str(mydata_siec)
data3 <- as.matrix(mydata_siec)
set.seed(124)
ind <- sample(2, nrow(data3), replace = T, prob = c(0.7, 0.3))
training <- data3[ind==1, ]
test <- data3[ind==2, ]
trainingtarget <- data3[ind==8]
testtarget <- data3[ind==16]

n <- neuralnet(Smierc~Jedendzien +Srednielozka+Leczeniogolem+Szpitalne+Pobyt,
               data = mydata_siec,
               hidden = c(6,2),
               linear.output = F,
               lifesign = 'full',
               rep=1)

```

```{r, echo=FALSE}

plot(n,rep = "best",col.hidden = 'darkgreen',     
     col.hidden.synapse = 'darkgreen',
     show.weights = F,
     information = F,
     fill = 'lightblue')
```

```{r, echo=FALSE}

n$result.matrix
output <- compute(n, rep = 1, training)
head(output$net.result)
```

Przewidywania uzyskane na podstawie regresji.

```{r, echo=FALSE}
#regresja
      plot(1:16,smierc_vec,col="red",xlab = "Numer województwa", ylab = "Liczba zgonów",pch=20,cex=2, main="Predykowane zgony dla kolejnych numerów województw")
```

Przewidywania uzyskane na podstawie sieci neuronowej.

```{r, echo=FALSE}
#sieć
      plot(1:16,n$response,col="blue",xlab = "Numer województwa", ylab = "Liczba zgonów",pch=20,cex=2, main="Predykowane zgony dla kolejnych numerów województw")
```

Rezultaty osiągnięte przy pomocy obu metod dają zbliżone wyniki. 
